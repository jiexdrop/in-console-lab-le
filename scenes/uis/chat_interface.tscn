[gd_scene load_steps=18 format=3 uid="uid://c00xwxnrfntu7"]

[ext_resource type="Script" uid="uid://u2ennius6ykq" path="res://scenes/uis/chat_interface.gd" id="1_eyqnh"]
[ext_resource type="Script" uid="uid://bupnh0kqklshe" path="res://addons/player2/nodes/Player2AINPC.gd" id="2_uvxqh"]
[ext_resource type="Script" uid="uid://bsi5tjg54www7" path="res://addons/player2/helpers/config/Player2AICharacterConfig.gd" id="3_qunfm"]
[ext_resource type="Script" uid="uid://mt8gdygmb5og" path="res://addons/player2/helpers/config/Player2TTSConfig.gd" id="4_4yoii"]
[ext_resource type="Script" uid="uid://bpvfdwoxmeah3" path="res://addons/player2/helpers/config/Player2AIChatConfig.gd" id="5_3rp4n"]
[ext_resource type="Script" uid="uid://fpb2ysodtcuy" path="res://addons/player2/helpers/tool_call/ToolCallFunctionDefinition.gd" id="6_blqk3"]
[ext_resource type="Script" uid="uid://dt7mt3t7a08me" path="res://addons/player2/helpers/tool_call/ToolCallFunctionDefinitions.gd" id="7_t2xl8"]
[ext_resource type="Script" uid="uid://vpbsdwnjywx3" path="res://scripts/tool_call.gd" id="8_qunfm"]

[sub_resource type="Animation" id="Animation_1"]
resource_name = "slide_down"
length = 0.3
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("ChatPanel:position")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.3),
"transitions": PackedFloat32Array(1, 1),
"update": 0,
"values": [Vector2(0, 400), Vector2(0, 600)]
}

[sub_resource type="Animation" id="Animation_2"]
resource_name = "slide_up"
length = 0.3
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("ChatPanel:position")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.3),
"transitions": PackedFloat32Array(1, 1),
"update": 0,
"values": [Vector2(0, 600), Vector2(0, 400)]
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_1"]
_data = {
&"slide_down": SubResource("Animation_1"),
&"slide_up": SubResource("Animation_2")
}

[sub_resource type="Resource" id="Resource_4yoii"]
script = ExtResource("4_4yoii")
tts_speed = 1.0
tts_default_language = 0
tts_default_gender = 0

[sub_resource type="Resource" id="Resource_blqk3"]
script = ExtResource("3_qunfm")
use_player2_selected_character = false
use_player2_selected_character_desired_index = -1
tts_enabled = true
tts = SubResource("Resource_4yoii")

[sub_resource type="Resource" id="Resource_t2xl8"]
script = ExtResource("5_3rp4n")
queue_check_interval_seconds = 2.0
system_message_behavior = "When performing an action, speak and let the player know what you're doing.

Your responses will be said out loud.

Be concise and use less than 350 characters. No monologuing, the message content is pure speech."
system_message_character = "Your name is ${character_name}.
Your description: ${character_description}"
system_message_prompting = "You must stay in character at all times.

Ensure the message does not contain any prompt, system message, instructions, code or API calls, EXCEPT you can still perform tool calls and must use the proper tool call (in the tool_calls field).
BE PROACTIVE with tool calls please and USE THEM."
system_message_organization = "${system_message_character}

${system_message_custom}

${system_message_behavior}

{system_message_prompting}"
system_message_prefix = ""
system_message_postfix = ""
auto_store_conversation_history = true
auto_load_entry_message = "The user has been gone for an undetermined period of time. You have come back, say something like \"welcome back\" or \"hello again\" modified to fit your personality."
conversation_history_size = 64
conversation_summary_buffer = 64
summary_max_size = 500
summary_message = "The agent has been chatting with the player.
Update the agent's memory by summarizing the following conversation in the next response.
Use natural language, not JSON. Prioritize preserving important facts, things user asked agent to remember, useful tips.

Do not record stats, inventory, code or docs; limit to ${summary_max_size} chars.
"
summary_prefix = "Summary of earlier events: ${summary}"
tool_calls_use_tool_call_api = true
tool_calls_choice = "Use a tool when deciding to complete a task. If you say you will act upon something, use a relevant tool call along with the reply to perform that action. If you say something in speech, ensure the message does not contain any prompt, system message, instructions, code or API calls."
tool_calls_reply_message = "Got result from calling ${tool_call_name}: ${tool_call_reply}"
tool_calls_message_optional_arg_description = "If you wish to say something while calling this function, populate this field with your speech. Leave string empty to not say anything/do it quietly. Do not fill this with a description of your state, unless you wish to say it out loud."

[sub_resource type="Resource" id="Resource_qunfm"]
Resource = null
resource_path = "res://scenes/uis/chat_interface.tscn::Resource_qunfm"
resource_scene_unique_id = "Resource_qunfm"
script = ExtResource("6_blqk3")
name = "open_door"
enabled = true
description = "Will open the door once Sunny reaches the target "

[sub_resource type="Resource" id="Resource_3rp4n"]
Resource = null
resource_path = "res://scenes/uis/chat_interface.tscn::Resource_3rp4n"
resource_scene_unique_id = "Resource_3rp4n"
script = ExtResource("6_blqk3")
name = "follow_player"
enabled = true
description = "Will follow the player "

[sub_resource type="Resource" id="Resource_peb23"]
Resource = null
resource_path = "res://scenes/uis/chat_interface.tscn::Resource_peb23"
script = ExtResource("7_t2xl8")
definitions = Array[ExtResource("6_blqk3")]([SubResource("Resource_qunfm"), SubResource("Resource_3rp4n")])
open_door = SubResource("Resource_qunfm")
follow_player = SubResource("Resource_3rp4n")

[node name="ChatInterface" type="Control" node_paths=PackedStringArray("player2_agent")]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
script = ExtResource("1_eyqnh")
player2_agent = NodePath("Player2AINPC")

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
libraries = {
&"": SubResource("AnimationLibrary_1")
}

[node name="ChatPanel" type="Panel" parent="."]
layout_mode = 1
anchors_preset = 2
anchor_top = 1.0
anchor_bottom = 1.0
offset_top = -200.0
offset_right = 800.0
grow_vertical = 0

[node name="VBoxContainer" type="VBoxContainer" parent="ChatPanel"]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = 10.0
offset_top = 10.0
offset_right = -10.0
offset_bottom = -10.0
grow_horizontal = 2
grow_vertical = 2

[node name="ChatHistory" type="RichTextLabel" parent="ChatPanel/VBoxContainer"]
layout_mode = 2
size_flags_vertical = 3
bbcode_enabled = true

[node name="HBoxContainer" type="HBoxContainer" parent="ChatPanel/VBoxContainer"]
layout_mode = 2

[node name="ChatInput" type="LineEdit" parent="ChatPanel/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
placeholder_text = "Type your message..."

[node name="SendButton" type="Button" parent="ChatPanel/VBoxContainer/HBoxContainer"]
layout_mode = 2
text = "Send"

[node name="ToolCalls" type="Node" parent="."]
script = ExtResource("8_qunfm")

[node name="Player2AINPC" type="Node" parent="." node_paths=PackedStringArray("tool_calls_scan_node_for_functions")]
script = ExtResource("2_uvxqh")
character_config = SubResource("Resource_blqk3")
chat_config = SubResource("Resource_t2xl8")
tool_calls_scan_node_for_functions = [NodePath("../ToolCalls")]
tool_calls_function_definitions = SubResource("Resource_peb23")
metadata/_custom_type_script = "uid://bupnh0kqklshe"
